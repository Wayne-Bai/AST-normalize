// Generated by CoffeeScript 1.2.1-pre
(function() {
  var Agent, Call, CallController, CallDTMFController, CallTransferController, ControlController, MakeCallController, StateController, StatusController, meta, p,
    __hasProp = {}.hasOwnProperty,
    __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor; child.__super__ = parent.prototype; return child; },
    __slice = [].slice;

  p = function() {
    var _ref;
    return (_ref = window.console) != null ? _ref.debug.apply(_ref, arguments) : void 0;
  };

  meta = {
    socket: null,
    calls: new Serenade.Collection([])
  };

  Serenade.view('status', "li#status.btn-group[data-toggle=\"buttons-radio\"]\n  button.btn.btn-success.available[event:click=statusAvailable!] \"Available\"\n  button.btn.btn-info.on-break[event:click=statusOnBreak!] \"On Break\"\n  button.btn.btn-primary.logged-out[event:click=statusLoggedOut!] \"Logged Out\"");

  Serenade.view('state', "li#state.btn-group[data-toggle=\"buttons-radio\"]\n  button.btn.btn-success.waiting[event:click=stateWaiting!] \"Ready\"\n  button.btn.btn-info.disabled.in-a-queue-call[disabled=\"disabled\"] \"In a queue call\"\n  button.btn.btn-primary.idle[event:click=stateIdle!] \"Wrap Up\"");

  Serenade.view('control', "li#control\n  .btn-group\n    button.btn.btn-primary.disabled.call-me[disabled=\"disabled\" event:click=callMe!] \"Call Me\"\n    button.btn.btn-primary[event:click=makeCallToggle!] \"Make Call\"\n    button.btn.btn-danger.logout[event:click=logout!] \"Logout\"");

  Serenade.view('makeCall', "#makeCall.modal\n  .modal-body\n    a.close[data-dismiss=\"modal\"] \"\u2715\"\n    form.form-inline\n      input.number.input-small[type=\"text\" placeholder=\"Number to dial\"]\n      input.identifier.input-small[type=\"text\" placeholder=\"Identifier\"]\n      button.btn[type=\"submit\" event:click=makeCall!] \"Make Call\"");

  Serenade.view('callTransfer', "#callTransfer.modal\n  .modal-body\n    a.close[data-dismiss=\"modal\"] \"\u2715\"\n    form.form-inline\n      input.number.input-small[type=\"text\" placeholder=\"Destination\"]\n      button.btn[type=\"submit\" event:click=callTransfer!] \"Transfer Call\"");

  Serenade.view('callDTMF', "#callDTMF.modal\n  .modal-body\n    a.close[data-dismiss=\"modal\"] \"\u2715\"\n    form.form-inline\n      input.number.input-small[type=\"text\" placeholder=\"DTMF Tones\" event:input=sendDTMF!]");

  Serenade.view('calls', ".container\n  #calls.span12\n    .row\n      - collection @calls\n        - view \"call\"");

  Serenade.view('call', ".call.alert.alert-info.span3\n  a.close[data-dismiss=\"alert\" event:click=hangup!] \"\u2715\"\n  .row\n    a.span1.transfer[href=\"#\" event:click=transfer!] \"Transfer\"\n    a.span1.dtmf[href=\"#\" event:click=dtmf!] \"DTMF\"\n    .span3.cid @display_cid\n    .span1.queue @queue\n    .span1.time @duration");

  StatusController = (function() {

    StatusController.name = 'StatusController';

    function StatusController(options) {
      var _this = this;
      this.options = options;
      this.agent = this.options.agent;
      this.agent.bind('change:status', function(newStatus) {
        switch (newStatus) {
          case "Available":
            return $('.available', _this.view).button('toggle');
          case "On Break":
            return $('.on-break', _this.view).button('toggle');
          case "Logged Out":
            return $('.logged-out', _this.view).button('toggle');
        }
      });
    }

    StatusController.prototype.statusAvailable = function(event) {
      event.stopPropagation();
      return meta.socket.ribbon('status', {
        status: 'Available'
      });
    };

    StatusController.prototype.statusOnBreak = function() {
      event.stopPropagation();
      return meta.socket.ribbon('status', {
        status: 'On Break'
      });
    };

    StatusController.prototype.statusLoggedOut = function() {
      event.stopPropagation();
      return meta.socket.ribbon('status', {
        status: 'Logged Out'
      });
    };

    return StatusController;

  })();

  Serenade.controller('status', StatusController);

  StateController = (function() {

    StateController.name = 'StateController';

    function StateController(options) {
      var _this = this;
      this.options = options;
      this.agent = this.options.agent;
      this.agent.bind('change:state', function(newState) {
        switch (newState) {
          case "Idle":
            return $('.idle', _this.view).button('toggle');
          case "Waiting":
            return $('.waiting', _this.view).button('toggle');
          case "Receiving":
            return $('.receiving', _this.view).button('toggle');
          case "In a queue call":
            return $('.in-a-queue-call', _this.view).button('toggle');
        }
      });
    }

    StateController.prototype.stateWaiting = function() {
      event.stopPropagation();
      return meta.socket.ribbon('state', {
        state: 'Waiting'
      });
    };

    StateController.prototype.stateIdle = function() {
      event.stopPropagation();
      return meta.socket.ribbon('state', {
        state: 'Idle'
      });
    };

    return StateController;

  })();

  Serenade.controller('state', StateController);

  ControlController = (function() {

    ControlController.name = 'ControlController';

    function ControlController(options) {
      var _this = this;
      this.options = options;
      this.agent = this.options.agent;
      this.agent.bind('change:offHook', function(newOffHook) {
        p('newOffHook', newOffHook);
        if (newOffHook) {
          return $('.call-me', _this.view).removeAttr('disabled').removeClass('disabled');
        } else {
          return $('.call-me', _this.view).attr('disabled', 'disabled').addClass('disabled');
        }
      });
    }

    ControlController.prototype.callMe = function() {
      return meta.socket.ribbon('call_me');
    };

    ControlController.prototype.makeCallToggle = function() {
      return $(Serenade.render('makeCall')).modal();
    };

    ControlController.prototype.logout = function() {
      return p("Log out");
    };

    return ControlController;

  })();

  Serenade.controller('control', ControlController);

  MakeCallController = (function() {

    MakeCallController.name = 'MakeCallController';

    function MakeCallController() {}

    MakeCallController.prototype.makeCall = function(event) {
      var identifier, number,
        _this = this;
      number = $('input.number', this.view).val();
      identifier = $('input.identifier', this.view).val();
      meta.socket.ribbon('call', {
        number: number,
        identifier: identifier
      });
      $(this.view).modal('hide');
      return setTimeout((function() {
        return $(_this.view).remove();
      }), 1000);
    };

    return MakeCallController;

  })();

  Serenade.controller('makeCall', MakeCallController);

  CallTransferController = (function() {

    CallTransferController.name = 'CallTransferController';

    function CallTransferController() {}

    CallTransferController.prototype.callTransfer = function(event) {
      var number,
        _this = this;
      number = $('input.number', this.view).val();
      meta.socket.ribbon('transfer', {
        number: number,
        uuid: this.model.call.id
      });
      $(this.view).modal('hide');
      return setTimeout((function() {
        return $(_this.view).remove();
      }), 1000);
    };

    return CallTransferController;

  })();

  Serenade.controller('callTransfer', CallTransferController);

  CallDTMFController = (function() {

    CallDTMFController.name = 'CallDTMFController';

    function CallDTMFController() {}

    CallDTMFController.prototype.sendDTMF = function(event) {
      var tones;
      tones = $('input', this.view).val();
      meta.socket.ribbon('dtmf', {
        uuid: this.model.call.id,
        tones: tones
      });
      return $('input', this.view).val('');
    };

    return CallDTMFController;

  })();

  Serenade.controller('callDTMF', CallDTMFController);

  CallController = (function() {

    CallController.name = 'CallController';

    function CallController() {}

    CallController.prototype.hangup = function(event) {
      event.stopPropagation();
      return meta.socket.ribbon('hangup', {
        uuid: this.model.id,
        cause: 'EAR hangup'
      });
    };

    CallController.prototype.transfer = function(event) {
      return $(Serenade.render('callTransfer', {
        call: this.model
      })).modal();
    };

    CallController.prototype.dtmf = function(event) {
      return $(Serenade.render('callDTMF', {
        call: this.model
      })).modal();
    };

    return CallController;

  })();

  Serenade.controller('call', CallController);

  Call = (function(_super) {

    __extends(Call, _super);

    Call.name = 'Call';

    Call.property('initializeRan');

    Call.property('queue');

    Call.property('display_cid');

    Call.property('created_epoch');

    Call.property('duration');

    Call.property('created', {
      get: (function() {
        return this.created_epoch * 1000;
      }),
      dependsOn: ['created_epoch']
    });

    function Call() {
      Call.__super__.constructor.apply(this, arguments);
      if (this.initializeRan == null) {
        if (typeof this.initialize === "function") {
          this.initialize.apply(this, arguments);
        }
      }
      this.initializeRan = true;
    }

    Call.prototype.initialize = function() {
      var _this = this;
      p("Created Call:", this);
      return this.timer = setInterval((function() {
        return _this.duration = Rubyists.formatInterval(_this.created);
      }), 500);
    };

    return Call;

  })(Serenade.Model);

  Agent = (function(_super) {

    __extends(Agent, _super);

    Agent.name = 'Agent';

    Agent.property('initializeRan');

    Agent.property('name');

    Agent.property('status');

    Agent.property('state');

    Agent.property('offHook');

    function Agent() {
      Agent.__super__.constructor.apply(this, arguments);
      if (this.initializeRan == null) {
        if (typeof this.initialize === "function") {
          this.initialize.apply(this, arguments);
        }
      }
      this.initializeRan = true;
    }

    Agent.prototype.initialize = function() {
      return p("Created Agent:", this);
    };

    return Agent;

  })(Serenade.Model);

  $(function() {
    var server;
    server = $('#console .server').text();
    meta.socket = new Rubyists.Socket({
      server: server
    });
    return meta.socket.onopen = function() {
      var agent;
      Serenade.clearCache();
      agent = new Agent({
        id: $('#console .extension').text(),
        name: $('#console .agent').text()
      });
      meta.socket.tag('ribbon:initialStatus', function(msg) {
        var raw, rawCall;
        p('init status', msg);
        raw = msg.body;
        agent.set(raw.agent);
        return meta.calls.update((function() {
          var _i, _len, _ref, _results;
          _ref = raw.calls;
          _results = [];
          for (_i = 0, _len = _ref.length; _i < _len; _i++) {
            rawCall = _ref[_i];
            _results.push(new Call(rawCall));
          }
          return _results;
        })());
      });
      meta.socket.tag('ribbon:Call:create', function(msg) {
        var call, raw;
        p('call create', msg);
        raw = msg.body;
        call = new Call(raw);
        return meta.calls.push(call);
      });
      meta.socket.tag('ribbon:Call:update', function(msg) {
        return p('call update', msg);
      });
      meta.socket.tag('ribbon:Call:delete', function(msg) {
        var call, toDelete, _i, _len, _results;
        p('call delete', msg);
        toDelete = meta.calls.select(function(call) {
          return call.id === msg.body.id;
        });
        _results = [];
        for (_i = 0, _len = toDelete.length; _i < _len; _i++) {
          call = toDelete[_i];
          _results.push(meta.calls["delete"](call));
        }
        return _results;
      });
      meta.socket.tag('ribbon:Agent:update', function(msg) {
        p('ribbon:Agent:update', msg);
        return agent.set(msg.body);
      });
      meta.socket.tag('ribbon', function() {
        return p.apply(null, ['ribbon'].concat(__slice.call(arguments)));
      });
      return meta.socket.ribbon('subscribe', {
        agent: agent.name,
        success: function() {
          $('#status').replaceWith(Serenade.render('status', {
            agent: agent
          }));
          $('#state').replaceWith(Serenade.render('state', {
            agent: agent
          }));
          $('#control').replaceWith(Serenade.render('control', {
            agent: agent
          }));
          $('#calls').replaceWith(Serenade.render('calls', {
            calls: meta.calls
          }));
          agent.trigger('change:status', agent.status);
          agent.trigger('change:state', agent.state);
          return agent.trigger('change:offHook', agent.offHook);
        }
      });
    };
  });

}).call(this);
